---
title: Artificial Neural Networks
author: Adogbeji Agberien
date: '2021-04-27'
slug: []
categories: []
tags: []
subtitle: ''
summary: ''
authors: []
lastmod: '2021-04-27T22:34:27-04:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<div id="the-analysis" class="section level1">
<h1>The analysis</h1>
<p>Given data containing several variables that possibly inform on whether or not an individual left or stayed with a bank, can we make predictions on whether other users will leave or stay with the bank?</p>
<pre class="r"><code># Install and load packages
required_packages &lt;- c(&quot;tidyverse&quot;, &quot;data.table&quot;, 
                       &quot;caTools&quot;, &quot;e1071&quot;, &quot;rpart&quot;, &quot;randomForest&quot;,
                       &quot;arules&quot;, &quot;h2o&quot;,
                       &quot;rmarkdown&quot;, &quot;knitr&quot;)

packageCheck &lt;- lapply(required_packages, FUN = function(x) {
  if(!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})</code></pre>
<p>Since we are using the <em>h20</em> package, we have to establish the connection to the server</p>
<pre class="r"><code>h2o.init(nthreads = -1)</code></pre>
<pre><code>##  Connection successful!
## 
## R is connected to the H2O cluster: 
##     H2O cluster uptime:         1 days 17 hours 
##     H2O cluster timezone:       America/New_York 
##     H2O data parsing timezone:  UTC 
##     H2O cluster version:        3.32.0.1 
##     H2O cluster version age:    6 months and 20 days !!! 
##     H2O cluster name:           H2O_started_from_R_diji__cti312 
##     H2O cluster total nodes:    1 
##     H2O cluster total memory:   1.97 GB 
##     H2O cluster total cores:    4 
##     H2O cluster allowed cores:  4 
##     H2O cluster healthy:        TRUE 
##     H2O Connection ip:          localhost 
##     H2O Connection port:        54321 
##     H2O Connection proxy:       NA 
##     H2O Internal Security:      FALSE 
##     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 
##     R Version:                  R version 4.0.4 (2021-02-15)</code></pre>
<p>Let us see what the data looks like.</p>
<pre class="r"><code># Show the first 3 rows of the data
churn_data[1:3]</code></pre>
<pre><code>##    RowNumber CustomerId  Surname CreditScore Geography Gender Age Tenure
## 1:         1   15634602 Hargrave         619    France Female  42      2
## 2:         2   15647311     Hill         608     Spain Female  41      1
## 3:         3   15619304     Onio         502    France Female  42      8
##      Balance NumOfProducts HasCrCard IsActiveMember EstimatedSalary Exited
## 1:      0.00             1         1              1        101348.9      1
## 2:  83807.86             1         0              1        112542.6      0
## 3: 159660.80             3         1              0        113931.6      1</code></pre>
<pre class="r"><code>cat(&quot;No of observations: &quot;, nrow(churn_data), &quot;\nNo of labels: &quot;, ncol(churn_data))</code></pre>
<pre><code>## No of observations:  10000 
## No of labels:  14</code></pre>
<p>The data contains 10,000 observations of 14 variables - 13 predictors and 1 response i.e., “Exited”. Among the 13 predictors, there are obviously some variables that will not contribute to information on whether or not the customer will leave the bank. These variables include: Row number, Customer ID, Surname.</p>
<pre class="r"><code># Get the class of each variable
str(churn_data)</code></pre>
<pre><code>## Classes &#39;data.table&#39; and &#39;data.frame&#39;:   10000 obs. of  14 variables:
##  $ RowNumber      : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ CustomerId     : int  15634602 15647311 15619304 15701354 15737888 15574012 15592531 15656148 15792365 15592389 ...
##  $ Surname        : chr  &quot;Hargrave&quot; &quot;Hill&quot; &quot;Onio&quot; &quot;Boni&quot; ...
##  $ CreditScore    : int  619 608 502 699 850 645 822 376 501 684 ...
##  $ Geography      : chr  &quot;France&quot; &quot;Spain&quot; &quot;France&quot; &quot;France&quot; ...
##  $ Gender         : chr  &quot;Female&quot; &quot;Female&quot; &quot;Female&quot; &quot;Female&quot; ...
##  $ Age            : int  42 41 42 39 43 44 50 29 44 27 ...
##  $ Tenure         : int  2 1 8 1 2 8 7 4 4 2 ...
##  $ Balance        : num  0 83808 159661 0 125511 ...
##  $ NumOfProducts  : int  1 1 3 2 1 2 2 4 2 1 ...
##  $ HasCrCard      : int  1 0 1 0 1 1 1 1 0 1 ...
##  $ IsActiveMember : int  1 1 0 0 1 0 1 0 1 1 ...
##  $ EstimatedSalary: num  101349 112543 113932 93827 79084 ...
##  $ Exited         : int  1 0 1 0 0 1 0 1 0 0 ...
##  - attr(*, &quot;.internal.selfref&quot;)=&lt;externalptr&gt;</code></pre>
<p>From the data we want to include in our model, we see that Geography and Gender are categorical variables, meaning we have to encode these prior to use in our algorithm.</p>
<p>To get summary statistics on the data, I like the <em>describe</em> function from the Hmisc package. We see that there are no missing data. For Geography, there are 3 categories - France, Germany, and Spain, and their frequencies are 5014, 2509, and 2477 respectively. Genders are just female and male, and their frequencies are 4543 and 5457 respectively.</p>
<p>By looking at the mean of the different variables, we see that scaling of the variables will be necessary.</p>
<pre class="r"><code># Get some summary statistics on the data 
Hmisc::describe(churn_data)</code></pre>
<pre><code>## churn_data 
## 
##  14  Variables      10000  Observations
## --------------------------------------------------------------------------------
## RowNumber 
##        n  missing distinct     Info     Mean      Gmd      .05      .10 
##    10000        0    10000        1     5000     3334      501     1001 
##      .25      .50      .75      .90      .95 
##     2501     5000     7500     9000     9500 
## 
## lowest :     1     2     3     4     5, highest:  9996  9997  9998  9999 10000
## --------------------------------------------------------------------------------
## CustomerId 
##        n  missing distinct     Info     Mean      Gmd      .05      .10 
##    10000        0    10000        1 15690941    83068 15578824 15591167 
##      .25      .50      .75      .90      .95 
## 15628528 15690738 15753234 15790831 15803034 
## 
## lowest : 15565701 15565706 15565714 15565779 15565796
## highest: 15815628 15815645 15815656 15815660 15815690
## --------------------------------------------------------------------------------
## Surname 
##        n  missing distinct 
##    10000        0     2932 
## 
## lowest : Abazu    Abbie    Abbott   Abdullah Abdulov 
## highest: Zubarev  Zubareva Zuev     Zuyev    Zuyeva  
## --------------------------------------------------------------------------------
## CreditScore 
##        n  missing distinct     Info     Mean      Gmd      .05      .10 
##    10000        0      460        1    650.5      110      489      521 
##      .25      .50      .75      .90      .95 
##      584      652      718      778      812 
## 
## lowest : 350 351 358 359 363, highest: 846 847 848 849 850
## --------------------------------------------------------------------------------
## Geography 
##        n  missing distinct 
##    10000        0        3 
##                                   
## Value       France Germany   Spain
## Frequency     5014    2509    2477
## Proportion   0.501   0.251   0.248
## --------------------------------------------------------------------------------
## Gender 
##        n  missing distinct 
##    10000        0        2 
##                         
## Value      Female   Male
## Frequency    4543   5457
## Proportion  0.454  0.546
## --------------------------------------------------------------------------------
## Age 
##        n  missing distinct     Info     Mean      Gmd      .05      .10 
##    10000        0       70    0.999    38.92    11.35       25       27 
##      .25      .50      .75      .90      .95 
##       32       37       44       53       60 
## 
## lowest : 18 19 20 21 22, highest: 83 84 85 88 92
## --------------------------------------------------------------------------------
## Tenure 
##        n  missing distinct     Info     Mean      Gmd      .05      .10 
##    10000        0       11    0.991    5.013    3.323        1        1 
##      .25      .50      .75      .90      .95 
##        3        5        7        9        9 
## 
## lowest :  0  1  2  3  4, highest:  6  7  8  9 10
##                                                                             
## Value          0     1     2     3     4     5     6     7     8     9    10
## Frequency    413  1035  1048  1009   989  1012   967  1028  1025   984   490
## Proportion 0.041 0.104 0.105 0.101 0.099 0.101 0.097 0.103 0.102 0.098 0.049
## --------------------------------------------------------------------------------
## Balance 
##        n  missing distinct     Info     Mean      Gmd      .05      .10 
##    10000        0     6382    0.953    76486    69104        0        0 
##      .25      .50      .75      .90      .95 
##        0    97199   127644   149245   162712 
## 
## lowest :      0.00   3768.69  12459.19  14262.80  16893.59
## highest: 216109.88 221532.80 222267.63 238387.56 250898.09
## --------------------------------------------------------------------------------
## NumOfProducts 
##        n  missing distinct     Info     Mean      Gmd 
##    10000        0        4    0.772     1.53   0.5749 
##                                   
## Value          1     2     3     4
## Frequency   5084  4590   266    60
## Proportion 0.508 0.459 0.027 0.006
## --------------------------------------------------------------------------------
## HasCrCard 
##        n  missing distinct     Info      Sum     Mean      Gmd 
##    10000        0        2    0.623     7055   0.7055   0.4156 
## 
## --------------------------------------------------------------------------------
## IsActiveMember 
##        n  missing distinct     Info      Sum     Mean      Gmd 
##    10000        0        2    0.749     5151   0.5151   0.4996 
## 
## --------------------------------------------------------------------------------
## EstimatedSalary 
##        n  missing distinct     Info     Mean      Gmd      .05      .10 
##    10000        0     9999        1   100090    66409     9852    20274 
##      .25      .50      .75      .90      .95 
##    51002   100194   149388   179675   190155 
## 
## lowest :     11.58     90.07     91.75     96.27    106.67
## highest: 199909.32 199929.17 199953.33 199970.74 199992.48
## --------------------------------------------------------------------------------
## Exited 
##        n  missing distinct     Info      Sum     Mean      Gmd 
##    10000        0        2    0.487     2037   0.2037   0.3244 
## 
## --------------------------------------------------------------------------------</code></pre>
<pre class="r"><code># Data preprocessing 
churn_data_clean &lt;- churn_data[, !c(&quot;RowNumber&quot;, &quot;CustomerId&quot;, &quot;Surname&quot;)] %&gt;% 
  # Conver &quot;Geography&quot; and &quot;Gender&quot; to factors
  .[, c(&quot;Geography&quot;, &quot;Gender&quot;) := lapply(.SD, as.factor), .SDcols = c(&quot;Geography&quot;, &quot;Gender&quot;)] %&gt;% 
  # Scale the data
  .[, c(&quot;CreditScore&quot;, &quot;Age&quot;, &quot;Tenure&quot;, &quot;Balance&quot;, &quot;NumOfProducts&quot;, &quot;HasCrCard&quot;, &quot;IsActiveMember&quot;, &quot;EstimatedSalary&quot;) := 
      lapply(.SD, scale), .SDcols = c(&quot;CreditScore&quot;, &quot;Age&quot;, &quot;Tenure&quot;, &quot;Balance&quot;, &quot;NumOfProducts&quot;, &quot;HasCrCard&quot;, &quot;IsActiveMember&quot;, &quot;EstimatedSalary&quot;)]</code></pre>
<pre class="r"><code># Split the data into training and test sets 
set.seed(123)
sample_split = sample.split(churn_data_clean$Exited, SplitRatio = 0.8)
training_set = subset(churn_data_clean, sample_split == T)
test_set = subset(churn_data_clean, sample_split == F)</code></pre>
<pre class="r"><code># Fit an ANN on the training set
churn_ann &lt;- h2o.deeplearning(
  y = &quot;Exited&quot;, training_frame = as.h2o(training_set), 
  activation = &quot;Rectifier&quot;, hidden = 6, epochs = 100, 
  train_samples_per_iteration = -2)</code></pre>
<pre><code>## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%
## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================================================================| 100%</code></pre>
<pre class="r"><code>churn_ann</code></pre>
<pre><code>## Model Details:
## ==============
## 
## H2ORegressionModel: deeplearning
## Model ID:  DeepLearning_model_R_1619573950139_16 
## Status of Neuron Layers: predicting Exited, regression, gaussian distribution, Quadratic loss, 103 weights/biases, 5.1 KB, 800,000 training samples, mini-batch size 1
##   layer units      type dropout       l1       l2 mean_rate rate_rms momentum
## 1     1    15     Input  0.00 %       NA       NA        NA       NA       NA
## 2     2     6 Rectifier  0.00 % 0.000000 0.000000  0.142892 0.346926 0.000000
## 3     3     1    Linear      NA 0.000000 0.000000  0.000156 0.000067 0.000000
##   mean_weight weight_rms mean_bias bias_rms
## 1          NA         NA        NA       NA
## 2   -0.063854   1.316977 -1.049564 3.688807
## 3    0.182420   0.429987 -0.056082 0.000000
## 
## 
## H2ORegressionMetrics: deeplearning
## ** Reported on training data. **
## ** Metrics reported on full training frame **
## 
## MSE:  0.1068211
## RMSE:  0.326835
## MAE:  0.2083881
## RMSLE:  0.2282697
## Mean Residual Deviance :  0.1068211</code></pre>
<p>What we have above is a very simple neural network with one hidden layer, and it uses the recifier activation function. Next, let us evaluate our model using the test set</p>
<pre class="r"><code># Make a prediction on the test set
churn_predict_prob &lt;- h2o.predict(churn_ann, newdata = as.h2o(test_set))</code></pre>
<pre><code>## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%
## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</code></pre>
<pre class="r"><code>churn_test_pred &lt;- if_else(as.vector(churn_predict_prob) &gt; 0.5, 1, 0)</code></pre>
<pre class="r"><code># Create a confusion matrix to check prediction accuracy 
table(churn_test_pred, test_set$Exited)</code></pre>
<pre><code>##                
## churn_test_pred    0    1
##               0 1541  211
##               1   52  196</code></pre>
<pre class="r"><code># Print prediction accuracy
cat(&quot;Our model has a prediction accuracy of:&quot;, sum(1542, 198)/sum(1542, 209, 69, 198))</code></pre>
<pre><code>## Our model has a prediction accuracy of: 0.8622398</code></pre>
<pre class="r"><code>h2o.shutdown()</code></pre>
<pre><code>## Are you sure you want to shutdown the H2O instance running at http://localhost:54321/ (Y/N)?</code></pre>
</div>
